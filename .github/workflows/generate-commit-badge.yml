name: Generate Commit Badges (multi-repo)

on:
  schedule:
    - cron: '15 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_badge:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        repo:
          - Promptee
          - troubleshoot-ai-assist
          # add more repos here

    env:
      OWNER: attilagrynaeus
      BADGE_DIR: badges

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # calculate commits from target repo
      - name: Count commits
        id: commits
        run: |
          REPO="${{ matrix.repo }}"
          git clone --quiet --mirror "https://github.com/${OWNER}/${REPO}.git" tmp_repo
          COUNT=$(git --git-dir tmp_repo rev-list --all --count)
          rm -rf tmp_repo
          echo "commits=${COUNT}" >> "$GITHUB_OUTPUT"

      # generate the badge
      - name: Generate Badge SVG
        uses: emibcn/badge-action@v1
        with:
          label: "${{ matrix.repo }} commits"
          status: "${{ steps.commits.outputs.commits }}"
          color: green
          path: "${{ env.BADGE_DIR }}/${{ matrix.repo }}_commits.svg"

      - name: Commit and Push Badge
        run: |
          mkdir -p "${{ env.BADGE_DIR }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://github.com/${OWNER}/${GITHUB_REPOSITORY#*/}.git"
          git add "${{ env.BADGE_DIR }}/${{ matrix.repo }}_commits.svg"

          if git diff --cached --quiet; then
            echo "Nothing to commit for ${{ matrix.repo }} – skipping push."
            exit 0
          fi

          git commit -m "chore(badge): update ${{ matrix.repo }} badge → ${{ steps.commits.outputs.commits }} commits"

          for attempt in 1 2 3; do
            echo "Attempt $attempt: pulling latest and pushing..."
            git pull --rebase origin main && git push && exit 0
            sleep 3
          done

          echo "::error::Failed to push badge after 3 attempts"
          exit 1
