name: generate-commit-badges

on:
  schedule:
    - cron: "0 */6 * * *"   # 6 óránként frissít
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: commit-badge
  cancel-in-progress: false

jobs:
  build-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build contributions JSON (week/month/YTD)
        uses: actions/github-script@v7
        with:

          script: |
            const username = 'attilagrynaeus';
            const now = new Date();

            function startUTC(y,m,d){ return new Date(Date.UTC(y,m,d,0,0,0)); }
            const todayUTC   = startUTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());

            // ISO hét (hétfő a kezdete)
            let dow = todayUTC.getUTCDay(); if (dow === 0) dow = 7;
            const startWeek  = new Date(todayUTC); startWeek.setUTCDate(todayUTC.getUTCDate() - dow + 1);
            const startMonth = startUTC(now.getUTCFullYear(), now.getUTCMonth(), 1);
            const startYear  = startUTC(now.getUTCFullYear(), 0, 1);

            const q = `
              query($login:String!, $from:DateTime!, $to:DateTime!) {
                user(login:$login) {
                  contributionsCollection(from:$from, to:$to) {
                    totalCommitContributions
                    totalPullRequestContributions
                    totalIssueContributions
                    totalPullRequestReviewContributions
                  }
                }
              }`;

            async function getRange(from, to) {
              const res = await github.graphql(q, {
                login: username,
                from: from.toISOString(),
                to:   now.toISOString()
              });
              return res.user.contributionsCollection;
            }

            const [W,M,Y] = await Promise.all([
              getRange(startWeek, now),
              getRange(startMonth, now),
              getRange(startYear, now)
            ]);

            const out = {
              generatedAt: now.toISOString(),
              week:  { commits: W.totalCommitContributions, prs: W.totalPullRequestContributions, issues: W.totalIssueContributions, reviews: W.totalPullRequestReviewContributions },
              month: { commits: M.totalCommitContributions, prs: M.totalPullRequestContributions, issues: M.totalIssueContributions, reviews: M.totalPullRequestReviewContributions },
              ytd:   { commits: Y.totalCommitContributions, prs: Y.totalPullRequestContributions, issues: Y.totalIssueContributions, reviews: Y.totalPullRequestReviewContributions }
            };

            const fs = require('fs');
            fs.mkdirSync('badges', { recursive: true });
            fs.writeFileSync('badges/gh-contributions.json', JSON.stringify(out, null, 2));

      - name: Commit JSON
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(badges): update contributions JSON"
          file_pattern: badges/gh-contributions.json
