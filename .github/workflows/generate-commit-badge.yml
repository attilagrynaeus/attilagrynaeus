name: Generate Commit Badges (multi-repo)

on:
  schedule:
    - cron: '15 3 * * *'        # every day 03:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_badge:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1            # avoid concurrent pushes
      matrix:
        repo:
          - Promptee
          - troubleshoot-ai-assist
          # - add-more-here

    env:
      OWNER: attilagrynaeus
      BADGE_DIR: badges

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0         # full history ‚Üí safe rebase later

      - name: Count commits in ${{ matrix.repo }}
        id: commits
        run: |
          REPO="${{ matrix.repo }}"
          git clone --quiet --mirror "https://github.com/${OWNER}/${REPO}.git" tmp_repo
          COUNT=$(git --git-dir tmp_repo rev-list --all --count)
          rm -rf tmp_repo
          echo "commits=${COUNT}" >> "$GITHUB_OUTPUT"

      - name: Generate badge SVG
        uses: emibcn/badge-action@v1   # uses set-output; harmless warning
        with:
          label: "${{ matrix.repo }} commits"
          status: "${{ steps.commits.outputs.commits }}"
          color: green
          path: "${{ env.BADGE_DIR }}/${{ matrix.repo }}_commits.svg"

      - name: Commit and push badge
        run: |
          mkdir -p "${{ env.BADGE_DIR }}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ env.BADGE_DIR }}/${{ matrix.repo }}_commits.svg"

          # if git status is clean, skip push entirely
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  Nothing to commit for ${{ matrix.repo }}; skipping push."
            exit 0
          fi

          git commit -m "chore(badge): update ${{ matrix.repo }} ‚ûú ${{ steps.commits.outputs.commits }} commits"

          # rebase‚Äêand‚Äêpush with up to 3 retries
          for attempt in 1 2 3; do
            echo "üîÑ  Attempt $attempt to rebase & push ..."
            if git pull --rebase --autostash origin main && git push; then
              echo "‚úÖ  Pushed badge for ${{ matrix.repo }}"
              exit 0
            fi
            sleep 3
          done

          echo "::error::Failed to push badge for ${{ matrix.repo }} after 3 attempts"
          exit 1
