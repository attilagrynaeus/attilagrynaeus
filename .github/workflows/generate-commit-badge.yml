name: Generate Commit Badge

on:
  schedule:
    - cron: '15 3 * * *'  # Minden nap UTC 03:15-kor fut, nem ütközik másik workflow-val
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_REPO: "Promptee"
  BADGE_PATH: "commit-count-badge.svg"

jobs:
  generate_badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch total commits count
        id: commits
        run: |
          COMMITS=$(curl -s "https://api.github.com/repos/attilagrynaeus/$TARGET_REPO" | jq '.["size"]')
          echo "commits=$COMMITS" >> "$GITHUB_OUTPUT"
          
          # Check if commit count is positive integer
          if ! [[ "$COMMITS" =~ ^[0-9]+$ ]] || [[ "$COMMITS" -le 0 ]]; then
            echo "::error::Invalid commit count detected: $COMMITS"
            exit 1
          fi

      - name: Generate Badge SVG
        uses: emibcn/badge-action@v1
        with:
          label: "Commits"
          status: "${{ steps.commits.outputs.commits }}"
          color: "green"
          outputPath: "${{ env.BADGE_PATH }}"

      - name: Commit and Push Badge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ env.BADGE_PATH }}"
          git commit -m "chore: update commit badge (Commits: ${{ steps.commits.outputs.commits }})" || echo "Nothing to commit"
          git push
